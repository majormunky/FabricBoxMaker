<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>FabricBoxMaker</title>
		<link rel="stylesheet" href="styles.css">
	</head>
	<body>
		<canvas id="main-canvas"></canvas>
		<div class="toolbox" draggable="true" data-drag-element=".toolbox-header">
			<div class="toolbox-header">
				Tools
			</div>
			<div class="toolbox-body">
				<div>
					<label>Grid Size:</label>
					<input type="text" id="grid-size-input" value="30" />
				</div>
				<div>
					
					<button id="new-rect" class="btn">New Rect</button>
				</div>
				<div id="selected-item-info"></div>
			</div>
			
		</div>
		<script src="https://cdn.jsdelivr.net/npm/fabric@4.3.1/dist/fabric.min.js"></script>
		<script src="draggable.js"></script>
		<script src="main.js"></script>
		<script>
			let grid_size = 30;
			let grid_color = "#DDD"
			let canvas;
			let selected_item = null;
			let line_group = null;

			document.getElementById("grid-size-input").addEventListener("change", (event) => {
				let new_value = event.target.value;
				let new_value_int = parseInt(new_value, 10);
				if (isNaN(new_value_int)) {
					event.target.value = "";
					return false;
				}

				if ((new_value_int < 10) || ( new_value_int > 100)) {
					event.target.value = "";
					return false;
				}

				grid_size = new_value_int;
				draw_grid();
			});

			document.getElementById("new-rect").addEventListener("click", (event) => {
				let r = new fabric.Rect({
					left: 30,
					top: 30,
					width: 300,
					height: 300,
					fill: "green"
				});
				r.setControlsVisibility({mtr: false});
				canvas.add(r);
			})

			document.addEventListener("DOMContentLoaded", (event) => {
				canvas = new fabric.Canvas(document.getElementById("main-canvas"));
				canvas.on('object:moving', function(event) { 
					event.target.set({
				    	left: Math.round(event.target.left / grid_size) * grid_size,
				    	top: Math.round(event.target.top / grid_size) * grid_size
				  	});
				  	event.target.bringToFront();
				});

				canvas.on('selection:created', (event)=> {
					selected_item = event.target;
					update_selected_item_box();
				});

				canvas.on('selection:cleared', (event) => {
					console.log("selection cleared")
					selected_item = null;
					update_selected_item_box();
				})

				canvas.on('object:modified', function(event) {
					let current_width = event.target.get("width") * event.target.get("scaleX");
					let current_height = event.target.get("height") * event.target.get("scaleY");

					current_width = Math.round(current_width / grid_size) * grid_size;
					current_height = Math.round(current_height / grid_size) * grid_size;
					
					event.target.set({
				    	width: Math.max(current_width, grid_size),
				    	height: Math.max(current_height, grid_size),
				    	scaleX: 1.0,
				    	scaleY: 1.0,
				  	});

					event.target.set({
				    	left: Math.round(event.target.left / grid_size) * grid_size,
				    	top: Math.round(event.target.top / grid_size) * grid_size
				  	});

				  	update_selected_item_box();
				});

				make_draggable(document.querySelector(".toolbox"));
				resize_canvas();
				draw_grid();
				position_toolbox("top-right");
				update_selected_item_box();
			});

			window.addEventListener("resize", resize_canvas);
		</script>
	</body>
</html>
